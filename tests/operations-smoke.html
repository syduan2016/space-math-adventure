<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operations Smoke Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 { color: #00d9ff; }
        h2 { color: #b537f2; margin-top: 24px; }
        .pass { color: #39ff14; }
        .fail { color: #ff006e; }
        .test-result {
            padding: 4px 8px;
            margin: 2px 0;
            border-left: 3px solid #333;
            font-family: monospace;
            font-size: 14px;
        }
        .test-result.pass { border-left-color: #39ff14; }
        .test-result.fail { border-left-color: #ff006e; background: rgba(255,0,110,0.1); }
        .summary {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
        }
        .summary.all-pass { background: rgba(57,255,20,0.15); border: 2px solid #39ff14; }
        .summary.has-fail { background: rgba(255,0,110,0.15); border: 2px solid #ff006e; }
    </style>
</head>
<body>
    <h1>Operations Smoke Test</h1>
    <div id="results"></div>
    <div id="summary"></div>

    <!-- Load game scripts in dependency order -->
    <script src="../js/utils/constants.js"></script>
    <script src="../js/utils/helpers.js"></script>
    <script src="../js/utils/operationConfigs.js"></script>
    <script src="../js/game/QuestionGenerators.js"></script>

    <script>
        const resultsDiv = document.getElementById('results');
        const summaryDiv = document.getElementById('summary');
        let passCount = 0;
        let failCount = 0;

        function log(message, passed) {
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.textContent = `${passed ? '✓' : '✗'} ${message}`;
            resultsDiv.appendChild(div);
            if (passed) passCount++;
            else failCount++;
        }

        function heading(text) {
            const h2 = document.createElement('h2');
            h2.textContent = text;
            resultsDiv.appendChild(h2);
        }

        function testGenerator(name, operationType, configs) {
            heading(`${name} Generator`);

            configs.forEach(config => {
                const label = config.label || `level ${config.level}`;
                const generator = createQuestionGenerator(operationType, {
                    ...config,
                    answerChoices: 4
                });

                const questions = [];
                let crashes = false;

                try {
                    for (let i = 0; i < 50; i++) {
                        questions.push(generator.generate());
                    }
                } catch (e) {
                    crashes = true;
                    log(`${label}: CRASHED — ${e.message}`, false);
                }

                if (!crashes) {
                    log(`${label}: Generated 50 questions without crash`, true);
                }

                // Check correctAnswer is in answers array
                const allHaveCorrect = questions.every(q =>
                    q.answers.includes(q.correctAnswer)
                );
                log(`${label}: correctAnswer always in answers array`, allHaveCorrect);

                // Check no duplicate answers
                const noDuplicates = questions.every(q => {
                    const unique = new Set(q.answers);
                    return unique.size === q.answers.length;
                });
                log(`${label}: No duplicate answers`, noDuplicates);

                // Check operation field matches
                const operationCorrect = questions.every(q =>
                    q.operation === operationType
                );
                log(`${label}: operation field matches '${operationType}'`, operationCorrect);

                // Check math is correct
                let mathCorrect;
                if (operationType === 'multiplication') {
                    mathCorrect = questions.every(q =>
                        q.correctAnswer === q.operand1 * q.operand2
                    );
                } else if (operationType === 'addition') {
                    mathCorrect = questions.every(q =>
                        q.correctAnswer === q.operand1 + q.operand2
                    );
                } else if (operationType === 'subtraction') {
                    mathCorrect = questions.every(q =>
                        q.correctAnswer === q.operand1 - q.operand2
                    );
                } else if (operationType === 'division') {
                    mathCorrect = questions.every(q =>
                        q.correctAnswer === q.operand1 / q.operand2
                    );
                }
                if (mathCorrect !== undefined) {
                    log(`${label}: Correct answer is mathematically correct`, mathCorrect);
                }

                // For subtraction: no negative answers
                if (operationType === 'subtraction') {
                    const noNegativeAnswers = questions.every(q =>
                        q.answers.every(a => a >= 0)
                    );
                    log(`${label}: No negative numbers in answers`, noNegativeAnswers);

                    const noNegativeCorrect = questions.every(q =>
                        q.correctAnswer >= 0
                    );
                    log(`${label}: No negative correct answers`, noNegativeCorrect);
                }
            });
        }

        // Test Multiplication Generator
        testGenerator('Multiplication', 'multiplication', [
            { level: 1, table: 1, label: '1 Times Table' },
            { level: 3, table: 3, label: '3 Times Table' },
            { level: 5, table: 5, label: '5 Times Table' },
            { level: 7, table: 7, label: '7 Times Table' },
            { level: 9, table: 9, label: '9 Times Table' }
        ]);

        // Test Addition Generator
        testGenerator('Addition', 'addition', [
            { level: 1, label: 'Sums to 10', maxSum: 10 },
            { level: 3, label: 'Sums to 20', maxSum: 20 },
            { level: 5, label: 'Sums to 40', maxSum: 40 },
            { level: 7, label: 'Sums to 70', maxSum: 70 },
            { level: 9, label: 'Sums to 100', maxSum: 100 }
        ]);

        // Test Subtraction Generator
        testGenerator('Subtraction', 'subtraction', [
            { level: 1, label: 'Within 10', maxMinuend: 10 },
            { level: 3, label: 'Within 20', maxMinuend: 20 },
            { level: 5, label: 'Within 40', maxMinuend: 40 },
            { level: 7, label: 'Within 70', maxMinuend: 70 },
            { level: 9, label: 'Within 100', maxMinuend: 100 }
        ]);

        // Test buildLevelConfig utility
        heading('buildLevelConfig Utility');

        const mulConfig = buildLevelConfig('multiplication', 5);
        log(`buildLevelConfig('multiplication', 5).operation === 'multiplication'`, mulConfig.operation === 'multiplication');
        log(`buildLevelConfig('multiplication', 5).table === 5`, mulConfig.table === 5);
        log(`buildLevelConfig('multiplication', 5).label === '5 Times Table'`, mulConfig.label === '5 Times Table');

        const addConfig = buildLevelConfig('addition', 3);
        log(`buildLevelConfig('addition', 3).operation === 'addition'`, addConfig.operation === 'addition');
        log(`buildLevelConfig('addition', 3).label === 'Sums to 20'`, addConfig.label === 'Sums to 20');

        const subConfig = buildLevelConfig('subtraction', 6);
        log(`buildLevelConfig('subtraction', 6).operation === 'subtraction'`, subConfig.operation === 'subtraction');
        log(`buildLevelConfig('subtraction', 6).label === 'Within 50'`, subConfig.label === 'Within 50');

        // Test getProgressKey
        heading('getProgressKey Utility');
        log(`getProgressKey('multiplication', 5) === 'mul_5'`, getProgressKey('multiplication', 5) === 'mul_5');
        log(`getProgressKey('addition', 3) === 'add_3'`, getProgressKey('addition', 3) === 'add_3');
        log(`getProgressKey('subtraction', 7) === 'sub_7'`, getProgressKey('subtraction', 7) === 'sub_7');

        // Test isOperationLevelUnlocked
        heading('isOperationLevelUnlocked');
        log(`Level 1 always unlocked`, isOperationLevelUnlocked('addition', 1, {}));
        log(`Level 3 always unlocked`, isOperationLevelUnlocked('addition', 3, {}));
        log(`Level 4 locked with no progress`, !isOperationLevelUnlocked('addition', 4, {}));
        log(`Level 4 unlocked with high accuracy`, isOperationLevelUnlocked('addition', 4, { 'add_3': { accuracy: 90, gamesPlayed: 1 } }));
        log(`Level 4 unlocked with enough games`, isOperationLevelUnlocked('addition', 4, { 'add_3': { accuracy: 50, gamesPlayed: 5 } }));

        // Summary
        const total = passCount + failCount;
        summaryDiv.className = `summary ${failCount === 0 ? 'all-pass' : 'has-fail'}`;
        summaryDiv.textContent = failCount === 0
            ? `ALL ${total} TESTS PASSED`
            : `${passCount}/${total} passed, ${failCount} FAILED`;
    </script>
</body>
</html>
